<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profili Düzenle - Buharından</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #2196F3;
            text-decoration: none;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .edit-card {
            background: white;
            padding: 32px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h2 {
            font-size: 24px;
            margin-bottom: 24px;
            color: #1976D2;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-size: 13px;
            color: #666;
            margin-bottom: 6px;
            display: block;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.2s;
        }

        input:focus, select:focus {
            border-color: #2196F3;
            outline: none;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            border: none;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover { background: #1976D2; }

        .btn-secondary {
            background: white;
            border: 2px solid #ddd;
            color: #666;
            text-align: center;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-content">
            <a href="profile_page.html" class="logo">Buharından</a>
            <button class="logout-btn" onclick="handleLogout()">Çıkış yap</button>
        </div>
    </div>

    <div class="container">
        <div class="edit-card">
            <h2>Profili Düzenle</h2>

            <div id="formContainer">
                Yükleniyor...
            </div>
        </div>
    </div>

<script>
const API_BASE = "http://127.0.0.1:8000";

async function checkAuth() {
    const res = await fetch(`${API_BASE}/me`, { credentials: "include" });
    if (!res.ok) {
        window.location.href = "login_page.html";
        return null;
    }
    return res.json();
}

async function loadForm() {
    const user = await checkAuth();
    if (!user) return;

    document.getElementById("formContainer").innerHTML = `
        <div class="form-group">
            <label>Ad Soyad</label>
            <input type="text" id="name" value="${user.user_name}">
        </div>

        <div class="form-group">
            <label for="city">Şehir</label>
            <select id="city" required>
                <option value="">Şehir Seçin</option>

                ${getCities()
                    .map(city => `<option value="${city}" ${city === user.user_city ? "selected" : ""}>${city}</option>`)
                    .join("")}
            </select>
        </div>

        <div class="form-group">
            <label>Adres (Devamı)</label>
            <input type="text" id="address" value="${user.user_restofaddress}">
        </div>

        <div class="form-group">
            <label>Telefon</label>
            <input type="text" id="phone" value="${user.user_phonenumber}">
        </div>

        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">

        <div class="form-group">
            <label>Yeni Parola (Opsiyonel)</label>
            <input type="password" id="newPassword" placeholder="Boş bırakılırsa değişmez">
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="saveProfile('${user.user_id}')">Kaydet</button>
            <a href="profile_page.html" class="btn btn-secondary">İptal</a>
        </div>
    `;
}

function getCities() {
    return [
        "Adana","Adıyaman","Afyonkarahisar","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin","Aydın",
        "Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa",
        "Çanakkale","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan","Erzurum","Eskişehir",
        "Gaziantep","Giresun","Gümüşhane","Hakkâri","Hatay","Iğdır","Isparta","İstanbul","İzmir",
        "Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir",
        "Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş","Nevşehir",
        "Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Şanlıurfa","Şırnak",
        "Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];
}

async function saveProfile(userId) {
    const payload = {
        user_name: document.getElementById("name").value.trim(),
        user_city: document.getElementById("city").value.trim(),
        user_restofaddress: document.getElementById("address").value.trim(),
        user_phonenumber: document.getElementById("phone").value.trim(),
        new_password: document.getElementById("newPassword").value.trim() || null
    };

    const res = await fetch(`${API_BASE}/users/update/${userId}`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        alert("Profil güncellenemedi!");
        return;
    }

    alert("Profil başarıyla güncellendi!");
    window.location.href = "profile_page.html";
}

async function handleLogout() {
    await fetch(`${API_BASE}/logout`, { method: "POST", credentials: "include" });
    window.location.href = "login_page.html";
}

loadForm();
</script>

</body>
</html>
