<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İlan Ver - Buharından</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #2196F3;
            text-decoration: none;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .profile-btn,
        .logout-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .profile-btn {
            background: white;
            border: 1px solid #ddd;
        }

        .profile-btn:hover {
            background: #e0e0e0;
        }

        .logout-btn {
            background: #f44336;
            border: none;
            color: white;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .container {
            max-width: 800px;
            margin: 32px auto;
            padding: 0 16px 32px 16px;
        }

        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 24px 24px 28px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .card-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #222;
        }

        .card-subtitle {
            font-size: 13px;
            color: #777;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.15);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .cancel-btn {
            padding: 10px 16px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background: #f5f5f5;
        }

        .submit-btn {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .submit-btn:hover {
            background: #1976D2;
        }

        .error-message {
            margin-top: 10px;
            font-size: 13px;
            color: #d32f2f;
        }

        .success-message {
            margin-top: 10px;
            font-size: 13px;
            color: #2e7d32;
        }

        #listingGenres {
            height: auto;
            min-height: 90px;
            max-height: 160px;
        }


    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <a href="home_page.html" class="logo">Buharından</a>

            <div class="header-actions">
                <button class="profile-btn" onclick="window.location.href='profile_page.html'">Profilim</button>
                <button class="logout-btn" onclick="handleLogout()">Çıkış Yap</button>
            </div>
        </div>
    </div>

    <!-- FORM -->
    <div class="container">
        <div class="card">
            <div class="card-title">Yeni İlan Oluştur</div>
            <div class="card-subtitle">Bu sayfadan hızlıca yeni bir ilan ekleyebilirsin.</div>

            <form id="createListingForm" onsubmit="handleCreateListing(event)">

                <div class="form-group">
                    <label>İlan Başlığı *</label>
                    <input type="text" id="listingName" required>
                </div>

                <div class="form-group">
                    <label>Fiyat (₺) *</label>
                    <input type="number" id="listingPrice" required min="0" step="0.01">
                </div>

                <div class="form-group">
                    <label>Durum (Condition) *</label>
                    <select id="listingCondition" required>
                        <option value="">Seçiniz</option>
                        <option value="Kusursuz">Kusursuz</option>
                        <option value="İyi">İyi</option>
                        <option value="Orta">Orta</option>
                        <option value="Yıpranmış">Yıpranmış</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Tür (Birden Fazla Seçilebilir)</label>
                    <select id="listingGenres" multiple size="4">
                        <!-- JS tarafından doldurulacak -->
                    </select>
                    <div class="hint">CTRL (Windows) / CMD (Mac) ile çoklu seçim yapabilirsin.</div>
                </div>


                <div class="form-group">
                    <label>Ürün Görseli (Tek Resim)</label>
                    <input type="file" id="listingImageFile" accept="image/*">
                    <div class="hint">Yalnızca bir adet görsel yüklenebilir.</div>
                </div>


                <div class="form-group">
                    <label>Açıklama</label>
                    <textarea id="listingDesc"></textarea>
                </div>

                <div id="formMessage" class="error-message" style="display:none;"></div>
                <div id="formSuccess" class="success-message" style="display:none;"></div>

                <div class="actions">
                    <button type="button" class="cancel-btn" onclick="window.location.href='home_page.html'">Vazgeç</button>
                    <button type="submit" class="submit-btn">İlanı Oluştur</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000";

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/me`, { credentials: "include" });
                if (!res.ok) window.location.href = "login_page.html";
                window.currentUser = await res.json();
            } catch {
                window.location.href = "login_page.html";
            }
        }

        async function handleLogout() {
            await fetch(`${API_BASE}/logout`, { method: "POST", credentials: "include" });
            window.location.href = "login_page.html";
        }

        function today() {
            return new Date().toISOString().split("T")[0];
        }

        async function handleCreateListing(e) {
            e.preventDefault();

            const name = document.getElementById("listingName").value.trim();
            const price = parseFloat(document.getElementById("listingPrice").value);
            const cond = document.getElementById("listingCondition").value;
            const desc = document.getElementById("listingDesc").value.trim();
            const genreSelect = document.getElementById("listingGenres");
            const selectedGenres = Array.from(genreSelect.selectedOptions).map(op => parseInt(op.value));

            const msg = document.getElementById("formMessage");
            const ok = document.getElementById("formSuccess");
            msg.style.display = "none";
            ok.style.display = "none";

            if (!name || !price || !cond) {
                msg.textContent = "Zorunlu alanları doldurmalısın.";
                msg.style.display = "block";
                return;
            }

            const payload = {
                listing_name: name,
                listing_price: price,
                listing_condition: cond,
                listing_date: today(),
                listing_desc: desc || null,
                listing_imagepath: null,  // artık URL değil
                genres: selectedGenres
            };

            try {
                // 1) İlanı oluştur
                const response = await fetch(`${API_BASE}/listings/create`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("İlan oluşturulamadı.");

                const data = await response.json();
                const listingId = data.listing_id;

                // 2) Dosya var mı? Yükle
                const fileInput = document.getElementById("listingImageFile");
                if (fileInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append("file", fileInput.files[0]);

                    const uploadRes = await fetch(`${API_BASE}/listings/${listingId}/upload_image`, {
                        method: "POST",
                        credentials: "include",
                        body: formData
                    });

                    if (!uploadRes.ok) {
                        console.error("Görsel yüklenemedi.");
                    }
                }

                ok.textContent = "İlan başarıyla oluşturuldu. Yönlendiriliyorsun...";
                ok.style.display = "block";

                setTimeout(() => {
                    window.location.href = `listing_page.html?id=${listingId}`;
                }, 800);

            } catch (err) {
                msg.textContent = err.message;
                msg.style.display = "block";
            }
        }

        async function loadGenres() {
            try {
                const res = await fetch(`${API_BASE}/genres`);
                const data = await res.json();

                const select = document.getElementById("listingGenres");
                data.forEach(g => {
                    const op = document.createElement("option");
                    op.value = g.genre_id;
                    op.textContent = g.genre_name;
                    select.appendChild(op);
                });

            } catch (err) {
                console.error("Genre yüklenemedi:", err);
            }
        }


        window.addEventListener("DOMContentLoaded", async () => {
            await checkAuth();
            await loadGenres();
        });

    </script>

</body>
</html>
